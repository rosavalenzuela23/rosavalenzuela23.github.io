import{r as i,j as e,P as it,g as Y,b as A,h as dt,T as G,e as V,f as U,n as je,o as lt}from"./index-DngGMs-x.js";import{b as le,u as ke,c as ce,d as ct,g as Pe,P as W,e as xe,f as ve,h as ht,i as pt,S as ut,k as pe,K as ue,j as mt,l as $e,m as ft,n as gt,o as xt,p as Le,q as bt,r as yt,T as jt,s as Tt,t as Ct,M as kt,v as vt,w as wt,L as It,x as St,y as ze,B as Nt,z as _t,A as de,E as Et,F as Ot,G as He,H as Ce,I as Rt,J as Mt,N as me,O as Dt,Q as Ft,U as Lt,V as zt,W as Ht}from"./canvas-utils-Bo482CbG.js";import{B as Q}from"./label-B61IYMRO.js";import{c as ee,u as Ze}from"./theme-provider-Bg5O9Ay7.js";import{B as At}from"./link-wq2K7Eu_.js";import{u as Bt}from"./colors-D1Sckjvp.js";import{D as Pt}from"./database-type-C2NNW5SW.js";/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $t=ee("Magnet",[["path",{d:"m6 15-4-4 6.75-6.77a7.79 7.79 0 0 1 11 11L13 22l-4-4 6.39-6.36a2.14 2.14 0 0 0-3-3L6 15",key:"1i3lhw"}],["path",{d:"m5 8 4 4",key:"j6kj7e"}],["path",{d:"m12 15 4 4",key:"lnac28"}]]);/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Zt=ee("Redo",[["path",{d:"M21 7v6h-6",key:"3ptur4"}],["path",{d:"M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7",key:"1kgawr"}]]);/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Gt=ee("Scan",[["path",{d:"M3 7V5a2 2 0 0 1 2-2h2",key:"aa7l1z"}],["path",{d:"M17 3h2a2 2 0 0 1 2 2v2",key:"4qcy5o"}],["path",{d:"M21 17v2a2 2 0 0 1-2 2h-2",key:"6vwrx8"}],["path",{d:"M7 21H5a2 2 0 0 1-2-2v-2",key:"ioqczr"}]]);/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Vt=ee("TriangleAlert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ut=ee("Undo",[["path",{d:"M3 7v6h6",key:"1v2h90"}],["path",{d:"M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13",key:"1r6uu6"}]]);/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wt=ee("ZoomIn",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"11",x2:"11",y1:"8",y2:"14",key:"1vmskp"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]]);/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Yt=ee("ZoomOut",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]]);var Kt="Separator",Ae="horizontal",Xt=["horizontal","vertical"],Ge=i.forwardRef((a,t)=>{const{decorative:s,orientation:u=Ae,...c}=a,l=qt(u)?u:Ae,b=s?{role:"none"}:{"aria-orientation":l==="vertical"?l:void 0,role:"separator"};return e.jsx(it.div,{"data-orientation":l,...b,...c,ref:t})});Ge.displayName=Kt;function qt(a){return Xt.includes(a)}var Ve=Ge;const ge=Y.forwardRef(({className:a,orientation:t="horizontal",decorative:s=!0,...u},c)=>e.jsx(Ve,{ref:c,decorative:s,orientation:t,className:A("shrink-0 bg-border",t==="horizontal"?"h-[1px] w-full":"h-full w-[1px]",a),...u}));ge.displayName=Ve.displayName;var Jt=function a(t,s){if(t===s)return!0;if(t&&s&&typeof t=="object"&&typeof s=="object"){if(t.constructor!==s.constructor)return!1;var u,c,l;if(Array.isArray(t)){if(u=t.length,u!=s.length)return!1;for(c=u;c--!==0;)if(!a(t[c],s[c]))return!1;return!0}if(t.constructor===RegExp)return t.source===s.source&&t.flags===s.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===s.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===s.toString();if(l=Object.keys(t),u=l.length,u!==Object.keys(s).length)return!1;for(c=u;c--!==0;)if(!Object.prototype.hasOwnProperty.call(s,l[c]))return!1;for(c=u;c--!==0;){var m=l[c];if(!a(t[m],s[m]))return!1}return!0}return t!==t&&s!==s};const fe=dt(Jt),Qt=({id:a,sourceX:t,sourceY:s,targetX:u,targetY:c,source:l,target:m,selected:b,data:I})=>{var X,ne;const{getInternalNode:M,getEdge:O}=le(),{openRelationshipFromSidebar:T,selectSidebarSection:v}=ke(),{relationships:C}=ce(),f=I==null?void 0:I.relationship,y=i.useCallback(()=>{v("relationships"),T(a)},[a,T,v]),S=i.useMemo(()=>C.filter(j=>j.targetTableId===m&&j.sourceTableId===l||j.targetTableId===l&&j.sourceTableId===m).findIndex(j=>j.id===a),[C,a,l,m]),N=M(l),_=M(m),R=O(a),L=(ne=(X=R==null?void 0:R.sourceHandle)==null?void 0:X.startsWith)!=null&&ne.call(X,ct)?"right":"left",k=(N==null?void 0:N.measured.width)??0,B=L==="left"?t+3:t-k-10,p=L==="left"?t+k+9:t,K=(_==null?void 0:_.measured.width)??0,P=u-1,z=u+K+10,{sourceSide:$,targetSide:Z}=i.useMemo(()=>{const j={leftToLeft:Math.abs(B-P),leftToRight:Math.abs(B-z),rightToLeft:Math.abs(p-P),rightToRight:Math.abs(p-z)},se=Math.min(j.leftToLeft,j.leftToRight,j.rightToLeft,j.rightToRight);switch(Object.keys(j).find(E=>j[E]===se)){case"leftToRight":return{sourceSide:"left",targetSide:"right"};case"rightToLeft":return{sourceSide:"right",targetSide:"left"};case"rightToRight":return{sourceSide:"right",targetSide:"right"};default:return{sourceSide:"left",targetSide:"left"}}},[B,p,P,z]),[ae]=i.useMemo(()=>Pe({sourceX:$==="left"?B:p,sourceY:s,targetX:Z==="left"?P:z,targetY:c,borderRadius:14,sourcePosition:$==="left"?W.Left:W.Right,targetPosition:Z==="left"?W.Left:W.Right,offset:(S+1)*14}),[$,Z,B,p,P,z,s,c,S]),te=i.useMemo(()=>xe({cardinality:(f==null?void 0:f.sourceCardinality)??"one",selected:b??!1,side:$}),[f==null?void 0:f.sourceCardinality,b,$]),be=i.useMemo(()=>xe({cardinality:(f==null?void 0:f.targetCardinality)??"one",selected:b??!1,side:Z}),[f==null?void 0:f.targetCardinality,b,Z]);return e.jsxs(e.Fragment,{children:[e.jsx("path",{id:a,d:ae,markerStart:`url(#${te})`,markerEnd:`url(#${be})`,fill:"none",className:A(["react-flow__edge-path",`!stroke-2 ${b?"!stroke-pink-600":"!stroke-slate-400"}`]),onClick:j=>{j.detail===2&&y()}}),e.jsx("path",{d:ae,fill:"none",strokeOpacity:0,strokeWidth:20,className:"react-flow__edge-interaction",onClick:j=>{j.detail===2&&y()}})]})},Ue=Y.forwardRef(({className:a,...t},s)=>e.jsx("div",{ref:s,className:A("rounded-xl border bg-card text-card-foreground shadow",a),...t}));Ue.displayName="Card";const es=Y.forwardRef(({className:a,...t},s)=>e.jsx("div",{ref:s,className:A("flex flex-col space-y-1.5 p-6",a),...t}));es.displayName="CardHeader";const ts=Y.forwardRef(({className:a,...t},s)=>e.jsx("h3",{ref:s,className:A("font-semibold leading-none tracking-tight",a),...t}));ts.displayName="CardTitle";const ss=Y.forwardRef(({className:a,...t},s)=>e.jsx("p",{ref:s,className:A("text-sm text-muted-foreground",a),...t}));ss.displayName="CardDescription";const We=Y.forwardRef(({className:a,...t},s)=>e.jsx("div",{ref:s,className:A("p-6 pt-0",a),...t}));We.displayName="CardContent";const os=Y.forwardRef(({className:a,...t},s)=>e.jsx("div",{ref:s,className:A("flex items-center p-6 pt-0",a),...t}));os.displayName="CardFooter";const J=Y.forwardRef((a,t)=>e.jsx(Q,{ref:t,variant:"ghost",className:"w-[36px] p-2 hover:bg-primary-foreground",...a}));J.displayName=Q.displayName;const Be=a=>`${Math.round(a*100)}%`,as=({readonly:a})=>{const{updateDiagramUpdatedAt:t}=ce(),{t:s}=ve(),{redo:u,undo:c,hasRedo:l,hasUndo:m}=ht(),{getZoom:b,zoomIn:I,zoomOut:M,fitView:O}=le(),[T,v]=i.useState(Be(b()));pt({onChange:({zoom:_})=>{v(Be(_))}});const C=200,f=()=>{I({duration:C})},y=()=>{M({duration:C})},S=()=>{O({minZoom:1,maxZoom:1,duration:C})},N=i.useCallback(()=>{O({duration:500,padding:.1,maxZoom:.8})},[O]);return e.jsx("div",{className:"px-1",children:e.jsx(Ue,{className:"h-[44px] bg-secondary p-0 shadow-none",children:e.jsxs(We,{className:"flex h-full flex-row items-center p-1",children:[a?null:e.jsxs(e.Fragment,{children:[e.jsxs(G,{children:[e.jsx(V,{asChild:!0,children:e.jsx("span",{children:e.jsx(J,{onClick:t,children:e.jsx(ut,{})})})}),e.jsxs(U,{children:[s("toolbar.save"),e.jsx("span",{className:"ml-2 text-muted-foreground",children:pe[ue.SAVE_DIAGRAM].keyCombinationLabel})]})]}),e.jsx(ge,{orientation:"vertical"})]}),e.jsxs(G,{children:[e.jsx(V,{asChild:!0,children:e.jsx("span",{children:e.jsx(J,{onClick:N,children:e.jsx(Gt,{})})})}),e.jsxs(U,{children:[s("toolbar.show_all"),e.jsx("span",{className:"ml-2 text-muted-foreground",children:pe[ue.SHOW_ALL].keyCombinationLabel})]})]}),e.jsx(ge,{orientation:"vertical"}),e.jsxs(G,{children:[e.jsx(V,{asChild:!0,children:e.jsx("span",{children:e.jsx(J,{onClick:y,children:e.jsx(Yt,{})})})}),e.jsx(U,{children:s("toolbar.zoom_out")})]}),e.jsx(Q,{variant:"ghost",onClick:S,className:"w-[60px] p-2 hover:bg-primary-foreground",children:T}),e.jsxs(G,{children:[e.jsx(V,{asChild:!0,children:e.jsx("span",{children:e.jsx(J,{onClick:f,children:e.jsx(Wt,{})})})}),e.jsx(U,{children:s("toolbar.zoom_in")})]}),e.jsx(ge,{orientation:"vertical"}),e.jsxs(G,{children:[e.jsx(V,{asChild:!0,children:e.jsx("span",{children:e.jsx(J,{onClick:c,disabled:!m,children:e.jsx(Ut,{})})})}),e.jsxs(U,{children:[s("toolbar.undo"),e.jsx("span",{className:"ml-2 text-muted-foreground",children:pe[ue.UNDO].keyCombinationLabel})]})]}),e.jsxs(G,{children:[e.jsx(V,{asChild:!0,children:e.jsx("span",{children:e.jsx(J,{onClick:u,disabled:!l,children:e.jsx(Zt,{})})})}),e.jsxs(U,{children:[s("toolbar.redo"),e.jsx("span",{className:"ml-2 text-muted-foreground",children:pe[ue.REDO].keyCombinationLabel})]})]})]})})})},ns=()=>{const{showCardinality:a}=Ze(),t={one:"1",many:"N"},s=["left","right"],u=[!0,!1];return a?e.jsx("svg",{className:"marker-definitions absolute left-0 top-0 z-0 size-0",children:e.jsx("defs",{children:Object.entries(t).map(([c,l])=>s.map(m=>u.map(b=>e.jsxs("marker",{id:xe({cardinality:c,selected:b,side:m}),viewBox:"0 0 16 16",markerWidth:"16",markerHeight:"16",refX:m==="left"?"15":"1",refY:"8",children:[e.jsx("circle",{cx:"8",cy:"8",r:"5",className:A([b?"fill-pink-600":"fill-muted-foreground","stroke-background","stroke-[0.5]"])}),e.jsx("text",{x:"7.9",y:"8.4",fontSize:"6",fontWeight:"600",textAnchor:"middle",dominantBaseline:"middle",className:"fill-muted",children:l})]},xe({cardinality:c,selected:b,side:m})))))})}):null},rs=({children:a})=>{const{createTable:t,filteredSchemas:s,schemas:u,readonly:c}=ce(),{openCreateRelationshipDialog:l,openTableSchemaDialog:m}=mt(),{screenToFlowPosition:b}=le(),{t:I}=ve(),{isMd:M}=$e("md"),O=i.useCallback(v=>{var f;const C=b({x:v.clientX,y:v.clientY});if(((s==null?void 0:s.length)??0)>1)m({onConfirm:y=>t({x:C.x,y:C.y,schema:y}),schemas:u.filter(y=>s==null?void 0:s.includes(y.id))});else{const y=(s==null?void 0:s.length)===1?(f=u.find(S=>S.id===s[0]))==null?void 0:f.name:void 0;t({x:C.x,y:C.y,schema:y})}},[t,b,m,u,s]),T=i.useCallback(()=>{l()},[l]);return!M||c?e.jsx(e.Fragment,{children:a}):e.jsxs(ft,{children:[e.jsx(gt,{children:a}),e.jsxs(xt,{children:[e.jsx(Le,{onClick:O,children:I("canvas_context_menu.new_table")}),e.jsx(Le,{onClick:T,children:I("canvas_context_menu.new_relationship")})]})]})},is=({id:a,sourceX:t,sourceY:s,targetX:u,targetY:c,source:l,target:m,selected:b})=>{const{getInternalNode:I}=le(),{dependencies:M}=ce(),{openDependencyFromSidebar:O,selectSidebarSection:T}=ke(),v=i.useCallback(()=>{T("dependencies"),O(a)},[a,O,T]),C=i.useMemo(()=>M.filter(p=>p.tableId===m&&p.dependentTableId===l||p.tableId===l&&p.dependentTableId===m).findIndex(p=>p.id===a),[M,a,l,m]),f=I(l),y=I(m),{sourceTopY:S,sourceBottomY:N,targetTopY:_,targetBottomY:R}=i.useMemo(()=>{const p=(f==null?void 0:f.measured.height)??0,K=s+5,P=s+p+10,z=(y==null?void 0:y.measured.height)??0,$=c+1,Z=c+z+5;return{sourceTopY:K,sourceBottomY:P,targetTopY:$,targetBottomY:Z}},[f==null?void 0:f.measured.height,s,y==null?void 0:y.measured.height,c]),{sourceSide:L,targetSide:k}=i.useMemo(()=>{const p={topToTop:Math.abs(S-_),topToBottom:Math.abs(S-R),bottomToTop:Math.abs(N-_),bottomToBottom:Math.abs(N-R)},K=Math.min(p.topToTop,p.topToBottom,p.bottomToTop,p.bottomToBottom);switch(Object.keys(p).find(z=>p[z]===K)){case"topToBottom":return{sourceSide:"top",targetSide:"bottom"};case"bottomToTop":return{sourceSide:"bottom",targetSide:"top"};case"bottomToBottom":return{sourceSide:"bottom",targetSide:"bottom"};default:return{sourceSide:"top",targetSide:"top"}}},[S,N,_,R]),[B]=i.useMemo(()=>Pe({sourceX:t,sourceY:L==="top"?S:N,targetX:u,targetY:k==="top"?_:R,borderRadius:14,sourcePosition:L==="top"?W.Top:W.Bottom,targetPosition:k==="top"?W.Top:W.Bottom,offset:(C+1)*14}),[C,N,L,S,t,R,k,_,u]);return e.jsxs(e.Fragment,{children:[e.jsx("path",{id:a,d:B,fill:"none",className:A(["react-flow__edge-path",`!stroke-2 ${b?"!stroke-pink-600":"!stroke-blue-400"}`]),onClick:p=>{p.detail===2&&v()}}),e.jsx("path",{d:B,fill:"none",strokeOpacity:0,strokeWidth:20,className:"react-flow__edge-interaction",onClick:p=>{p.detail===2&&v()}})]})},ds={"relationship-edge":Qt,"dependency-edge":is},ls=[],Te=(a,t)=>({id:a.id,type:"table",position:{x:a.x,y:a.y},data:{table:a,isOverlapping:!1},width:a.width??kt,hidden:!Ce(a,t)}),xs=({initialTables:a,readonly:t})=>{const{getEdge:s,getInternalNode:u,getEdges:c,getNode:l}=le(),[m,b]=i.useState([]),[I,M]=i.useState([]),{toast:O}=bt(),{t:T}=ve(),{tables:v,relationships:C,createRelationship:f,createDependency:y,updateTablesState:S,removeRelationships:N,removeDependencies:_,getField:R,databaseType:L,filteredSchemas:k,events:B,dependencies:p}=ce(),{showSidePanel:K}=ke(),{effectiveTheme:P}=Bt(),{scrollAction:z,showDependenciesOnCanvas:$,showMiniMapOnCanvas:Z}=Ze(),{showAlert:ae}=yt(),{isMd:te}=$e("md"),be=i.useMemo(()=>({table:jt}),[]),[X,ne]=i.useState(!1),{reorderTables:j,fitView:se,setOverlapGraph:H,overlapGraph:E}=Tt(),[we,Ie]=i.useState(!0),[D,Se,Ne]=Ct(a.map(n=>Te(n,k))),[ye,he,_e]=vt(ls),[Ee,Ye]=i.useState(!1);i.useEffect(()=>{Ie(!0)},[a]),i.useEffect(()=>{const n=a.map(r=>Te(r,k));fe(n,D)&&Ie(!1)},[a,D,k]),i.useEffect(()=>{we||je(()=>{se({duration:200,padding:.1,maxZoom:.8})},500)()},[we,se]),i.useEffect(()=>{const n=C.reduce((o,h)=>(o[`${h.targetTableId}${h.targetFieldId}`]=0,o),{}),r=p.reduce((o,h)=>(o[h.tableId]=0,o),{});he([...C.map(o=>({id:o.id,source:o.sourceTableId,target:o.targetTableId,sourceHandle:`${It}${o.sourceFieldId}`,targetHandle:`${wt}${n[`${o.targetTableId}${o.targetFieldId}`]++}_${o.targetFieldId}`,type:"relationship-edge",data:{relationship:o}})),...p.map(o=>({id:o.id,source:o.dependentTableId,target:o.tableId,sourceHandle:`${ze}${o.dependentTableId}`,targetHandle:`${St}${r[o.tableId]++}_${o.tableId}`,type:"dependency-edge",data:{dependency:o},hidden:!$&&L!==Pt.CLICKHOUSE}))])},[C,p,he,$,L]),i.useEffect(()=>{const n=D.filter(r=>r.selected).map(r=>r.id);fe(n,m)||b(n)},[D,b,m]),i.useEffect(()=>{const n=ye.filter(r=>r.selected).map(r=>r.id);fe(n,I)||M(n)},[ye,M,I]),i.useEffect(()=>{const r=[...c().filter(o=>m.includes(o.source)||m.includes(o.target)).map(o=>o.id),...I];he(o=>o.map(h=>{const g=r.includes(h.id);if(h.type==="dependency-edge"){const x=h;return{...x,data:{...x.data,highlighted:g},animated:g,zIndex:g?1:0}}else{const x=h;return{...x,data:{...x.data,highlighted:g},animated:g,zIndex:g?1:0}}}))},[I,m,he,c]),i.useEffect(()=>{Se(v.map(n=>{const r=(E.graph.get(n.id)??[]).length>0,o=Te(n,k);return{...o,data:{...o.data,isOverlapping:r,highlightOverlappingTables:X}}}))},[v,Se,k,E.lastUpdated,E.graph,X]);const Oe=i.useRef(void 0);i.useEffect(()=>{fe(k,Oe.current)||(je(()=>{const n=He({tables:v.filter(r=>Ce(r,k))});H(n),se({duration:500,padding:.1,maxZoom:.8})},500)(),Oe.current=k)},[k,se,v,H]);const Ke=i.useCallback(async n=>{var w,F,q,re,ie,oe,De,Fe;if((F=(w=n.sourceHandle)==null?void 0:w.startsWith)!=null&&F.call(w,ze)||(re=(q=n.sourceHandle)==null?void 0:q.startsWith)!=null&&re.call(q,Nt)){const nt=n.target,rt=n.source;y({tableId:nt,dependentTableId:rt});return}const r=n.source,o=n.target,h=((oe=(ie=n.sourceHandle)==null?void 0:ie.split("_"))==null?void 0:oe.pop())??"",g=((Fe=(De=n.targetHandle)==null?void 0:De.split("_"))==null?void 0:Fe.pop())??"",x=R(r,h),d=R(o,g);if(!(!x||!d)){if(!_t(x.type,d.type,L)){O({title:"Field types are not compatible",variant:"destructive",description:"Relationships can only be created between compatible field types"});return}f({sourceTableId:r,targetTableId:o,sourceFieldId:h,targetFieldId:g})}},[f,y,R,O,L]),Xe=i.useCallback(n=>{let r=n;t&&(r=r.filter(d=>d.type!=="remove"));const h=r.filter(d=>d.type==="remove").map(d=>s(d.id)).filter(d=>!!d),g=h.filter(d=>(d==null?void 0:d.type)==="relationship-edge").map(d=>{var w,F;return(F=(w=d==null?void 0:d.data)==null?void 0:w.relationship)==null?void 0:F.id}),x=h.filter(d=>(d==null?void 0:d.type)==="dependency-edge").map(d=>{var w,F;return(F=(w=d==null?void 0:d.data)==null?void 0:w.dependency)==null?void 0:F.id});return g.length>0&&N(g),x.length>0&&_(x),_e(r)},[s,_e,N,_,t]),qe=i.useCallback(({positionChanges:n,sizeChanges:r})=>{if(n.length>0||r.length>0){let o=E;for(const h of n)o=de({node:l(h.id)},{nodes:D.filter(g=>!g.hidden)},o);for(const h of r)o=de({node:l(h.id)},{nodes:D.filter(g=>!g.hidden)},o);H(o)}},[D,E,H,l]),Re=je(qe,200),Je=i.useCallback(n=>{let r=n;t&&(r=r.filter(x=>x.type!=="remove"));const o=r.filter(x=>x.type==="position"&&!x.dragging),h=r.filter(x=>x.type==="remove"),g=r.filter(x=>x.type==="dimensions"&&x.resizing);return(o.length>0||h.length>0||g.length>0)&&S(x=>x.map(d=>{var q,re,ie;const w=o.find(oe=>oe.id===d.id),F=g.find(oe=>oe.id===d.id);return w||F?{id:d.id,...w?{x:(q=w.position)==null?void 0:q.x,y:(re=w.position)==null?void 0:re.y}:{},...F?{width:((ie=F.dimensions)==null?void 0:ie.width)??d.width}:{}}:d}).filter(d=>!h.some(w=>w.id===d.id))),Re({positionChanges:o,sizeChanges:g}),Ne(r)},[Ne,S,Re,t]),Qe=i.useCallback(n=>{let r=E;if(n.action==="add_tables"){for(const o of n.data.tables)r=de({node:l(o.id)},{nodes:D.filter(h=>!h.hidden)},E);H(r)}else if(n.action==="remove_tables"){for(const o of n.data.tableIds)r=Et(r,o);H(r)}else if(n.action==="update_table"&&n.data.table.width){const o=l(n.data.id),h={...o.measured,width:n.data.table.width};r=de({node:{...o,measured:h}},{nodes:D.filter(g=>!g.hidden)},E),H(r)}else if(n.action==="add_field"||n.action==="remove_field"){const o=l(n.data.tableId),h={...o.measured??{},height:Ot(n.data.fields.length)};r=de({node:{...o,measured:h}},{nodes:D.filter(g=>!g.hidden)},E),H(r)}else if(n.action==="load_diagram"){const o=n.data.diagram.tables??[],h=He({tables:o.filter(g=>Ce(g,k))});H(h)}},[E,H,l,D,k]);B.useSubscription(Qe);const et=v.length>0?!u(v[0].id):!1,tt=i.useCallback(()=>{ae({title:T("reorder_diagram_alert.title"),description:T("reorder_diagram_alert.description"),actionLabel:T("reorder_diagram_alert.reorder"),closeLabel:T("reorder_diagram_alert.cancel"),onAction:j})},[T,ae,j]),st=i.useMemo(()=>Array.from(E.graph).some(([,n])=>n.length>0),[E]),ot=i.useCallback(()=>{ne(!0),setTimeout(()=>ne(!1),600)},[]),Me=Rt("Shift"),at=lt();return e.jsx(rs,{children:e.jsxs("div",{className:"relative flex h-full",children:[e.jsxs(Mt,{colorMode:P,className:"canvas-cursor-default nodes-animated",nodes:D,edges:ye,onNodesChange:Je,onEdgesChange:Xe,maxZoom:5,minZoom:.1,onConnect:Ke,proOptions:{hideAttribution:!0},fitView:!1,nodeTypes:be,edgeTypes:ds,defaultEdgeOptions:{animated:!1,type:"relationship-edge"},panOnScroll:z==="pan",snapToGrid:Me||Ee,snapGrid:[20,20],children:[e.jsx(me,{position:"top-left",showZoom:!1,showFitView:!1,showInteractive:!1,className:"!shadow-none",children:e.jsxs("div",{className:"flex flex-col items-center gap-2 md:flex-row",children:[t?null:e.jsxs(e.Fragment,{children:[e.jsxs(G,{children:[e.jsx(V,{asChild:!0,children:e.jsx("span",{children:e.jsx(Q,{variant:"secondary",className:"size-8 p-1 shadow-none",onClick:tt,children:e.jsx(Dt,{className:"size-4"})})})}),e.jsx(U,{children:T("toolbar.reorder_diagram")})]}),e.jsxs(G,{children:[e.jsx(V,{asChild:!0,children:e.jsx("span",{children:e.jsx(Q,{variant:"secondary",className:A("size-8 p-1 shadow-none",Ee||Me?"bg-pink-600 text-white hover:bg-pink-500 dark:hover:bg-pink-700 hover:text-white":""),onClick:()=>Ye(n=>!n),children:e.jsx($t,{className:"size-4"})})})}),e.jsx(U,{children:T("snap_to_grid_tooltip",{key:at==="mac"?"⇧":"Shift"})})]})]}),e.jsx("div",{className:`transition-opacity duration-300 ease-in-out ${st?"opacity-100":"opacity-0"}`,children:e.jsxs(G,{children:[e.jsx(V,{asChild:!0,children:e.jsx("span",{children:e.jsx(Q,{variant:"default",className:"size-8 p-1 shadow-none",onClick:ot,children:e.jsx(Vt,{className:"size-4 text-white"})})})}),e.jsx(U,{children:T("toolbar.highlight_overlapping_tables")})]})})]})}),et?e.jsx(me,{position:"top-center",orientation:"horizontal",showZoom:!1,showFitView:!1,showInteractive:!1,className:"!shadow-none",children:e.jsx(At,{variant:"default",className:"bg-pink-600 text-white",children:T("loading_diagram")})}):null,!te&&!t?e.jsx(me,{position:"bottom-left",orientation:"horizontal",showZoom:!1,showFitView:!1,showInteractive:!1,className:"!shadow-none",children:e.jsx(Q,{className:"size-11 bg-pink-600 p-2 hover:bg-pink-500",onClick:K,children:e.jsx(Ft,{})})}):null,e.jsx(me,{position:te?"bottom-center":"top-center",orientation:"horizontal",showZoom:!1,showFitView:!1,showInteractive:!1,className:"!shadow-none",children:e.jsx(as,{readonly:t})}),Z&&e.jsx(Lt,{style:{width:te?100:60,height:te?100:60}}),e.jsx(zt,{variant:Ht.Dots,gap:16,size:1})]}),e.jsx(ns,{})]})})};export{xs as C,ge as S};
