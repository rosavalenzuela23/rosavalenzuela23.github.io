import{c as Ue,S as ee}from"./index-BKsfrmP9.js";import{z as s}from"./use-storage-CxjMvB6O.js";import"./index-DngGMs-x.js";import"./database-type-C2NNW5SW.js";class Be extends TransformStream{constructor(){let n;super({start(t){n=Ue(r=>{r.type==="event"&&t.enqueue(r)})},transform(t){n.feed(t)}})}}let Fe=(e,n=21)=>(t=n)=>{let r="",i=t;for(;i--;)r+=e[Math.random()*e.length|0];return r};var me="vercel.ai.error",De=Symbol.for(me),he,ze=class fe extends Error{constructor({name:n,message:t,cause:r}){super(t),this[he]=!0,this.name=n,this.cause=r}static isInstance(n){return fe.hasMarker(n,me)}static hasMarker(n,t){const r=Symbol.for(t);return n!=null&&typeof n=="object"&&r in n&&typeof n[r]=="boolean"&&n[r]===!0}toJSON(){return{name:this.name,message:this.message}}};he=De;var g=ze,B="AI_APICallError",ge=`vercel.ai.error.${B}`,Ke=Symbol.for(ge),be,E=class extends g{constructor({message:e,url:n,requestBodyValues:t,statusCode:r,responseHeaders:i,responseBody:a,cause:l,isRetryable:o=r!=null&&(r===408||r===409||r===429||r>=500),data:u}){super({name:B,message:e,cause:l}),this[be]=!0,this.url=n,this.requestBodyValues=t,this.statusCode=r,this.responseHeaders=i,this.responseBody=a,this.isRetryable=o,this.data=u}static isInstance(e){return g.hasMarker(e,ge)}static isAPICallError(e){return e instanceof Error&&e.name===B&&typeof e.url=="string"&&typeof e.requestBodyValues=="object"&&(e.statusCode==null||typeof e.statusCode=="number")&&(e.responseHeaders==null||typeof e.responseHeaders=="object")&&(e.responseBody==null||typeof e.responseBody=="string")&&(e.cause==null||typeof e.cause=="object")&&typeof e.isRetryable=="boolean"&&(e.data==null||typeof e.data=="object")}toJSON(){return{name:this.name,message:this.message,url:this.url,requestBodyValues:this.requestBodyValues,statusCode:this.statusCode,responseHeaders:this.responseHeaders,responseBody:this.responseBody,cause:this.cause,isRetryable:this.isRetryable,data:this.data}}};be=Ke;var F="AI_EmptyResponseBodyError",ye=`vercel.ai.error.${F}`,Ge=Symbol.for(ye),ve,Ye=class extends g{constructor({message:e="Empty response body"}={}){super({name:F,message:e}),this[ve]=!0}static isInstance(e){return g.hasMarker(e,ye)}static isEmptyResponseBodyError(e){return e instanceof Error&&e.name===F}};ve=Ge;function we(e){return e==null?"unknown error":typeof e=="string"?e:e instanceof Error?e.message:JSON.stringify(e)}var D="AI_InvalidPromptError",_e=`vercel.ai.error.${D}`,Qe=Symbol.for(_e),Ee,We=class extends g{constructor({prompt:e,message:n,cause:t}){super({name:D,message:`Invalid prompt: ${n}`,cause:t}),this[Ee]=!0,this.prompt=e}static isInstance(e){return g.hasMarker(e,_e)}static isInvalidPromptError(e){return e instanceof Error&&e.name===D&&prompt!=null}toJSON(){return{name:this.name,message:this.message,stack:this.stack,prompt:this.prompt}}};Ee=Qe;var z="AI_InvalidResponseDataError",ke=`vercel.ai.error.${z}`,Xe=Symbol.for(ke),Ie,V=class extends g{constructor({data:e,message:n=`Invalid response data: ${JSON.stringify(e)}.`}){super({name:z,message:n}),this[Ie]=!0,this.data=e}static isInstance(e){return g.hasMarker(e,ke)}static isInvalidResponseDataError(e){return e instanceof Error&&e.name===z&&e.data!=null}toJSON(){return{name:this.name,message:this.message,stack:this.stack,data:this.data}}};Ie=Xe;var K="AI_JSONParseError",Ce=`vercel.ai.error.${K}`,Ze=Symbol.for(Ce),xe,J=class extends g{constructor({text:e,cause:n}){super({name:K,message:`JSON parsing failed: Text: ${e}.
Error message: ${we(n)}`,cause:n}),this[xe]=!0,this.text=e}static isInstance(e){return g.hasMarker(e,Ce)}static isJSONParseError(e){return e instanceof Error&&e.name===K&&"text"in e&&typeof e.text=="string"}toJSON(){return{name:this.name,message:this.message,cause:this.cause,stack:this.stack,valueText:this.text}}};xe=Ze;var G="AI_LoadAPIKeyError",Se=`vercel.ai.error.${G}`,et=Symbol.for(Se),je,R=class extends g{constructor({message:e}){super({name:G,message:e}),this[je]=!0}static isInstance(e){return g.hasMarker(e,Se)}static isLoadAPIKeyError(e){return e instanceof Error&&e.name===G}};je=et;var Y="AI_TooManyEmbeddingValuesForCallError",Te=`vercel.ai.error.${Y}`,tt=Symbol.for(Te),Ae,nt=class extends g{constructor(e){super({name:Y,message:`Too many values for a single embedding call. The ${e.provider} model "${e.modelId}" can only embed up to ${e.maxEmbeddingsPerCall} values per call, but ${e.values.length} values were provided.`}),this[Ae]=!0,this.provider=e.provider,this.modelId=e.modelId,this.maxEmbeddingsPerCall=e.maxEmbeddingsPerCall,this.values=e.values}static isInstance(e){return g.hasMarker(e,Te)}static isTooManyEmbeddingValuesForCallError(e){return e instanceof Error&&e.name===Y&&"provider"in e&&typeof e.provider=="string"&&"modelId"in e&&typeof e.modelId=="string"&&"maxEmbeddingsPerCall"in e&&typeof e.maxEmbeddingsPerCall=="number"&&"values"in e&&Array.isArray(e.values)}toJSON(){return{name:this.name,message:this.message,stack:this.stack,provider:this.provider,modelId:this.modelId,maxEmbeddingsPerCall:this.maxEmbeddingsPerCall,values:this.values}}};Ae=tt;var Q="AI_TypeValidationError",Oe=`vercel.ai.error.${Q}`,st=Symbol.for(Oe),Pe,rt=class W extends g{constructor({value:n,cause:t}){super({name:Q,message:`Type validation failed: Value: ${JSON.stringify(n)}.
Error message: ${we(t)}`,cause:t}),this[Pe]=!0,this.value=n}static isInstance(n){return g.hasMarker(n,Oe)}static wrap({value:n,cause:t}){return W.isInstance(t)&&t.value===n?t:new W({value:n,cause:t})}static isTypeValidationError(n){return n instanceof Error&&n.name===Q}toJSON(){return{name:this.name,message:this.message,cause:this.cause,stack:this.stack,value:this.value}}};Pe=st;var H=rt,X="AI_UnsupportedFunctionalityError",$e=`vercel.ai.error.${X}`,ot=Symbol.for($e),Ne,y=class extends g{constructor({functionality:e}){super({name:X,message:`'${e}' functionality not supported.`}),this[Ne]=!0,this.functionality=e}static isInstance(e){return g.hasMarker(e,$e)}static isUnsupportedFunctionalityError(e){return e instanceof Error&&e.name===X&&typeof e.functionality=="string"}toJSON(){return{name:this.name,message:this.message,stack:this.stack,functionality:this.functionality}}};Ne=ot;var at={};function T(...e){return e.reduce((n,t)=>({...n,...t??{}}),{})}function q(e){const n={};return e.headers.forEach((t,r)=>{n[r]=t}),n}var j=Fe("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",7);function U(e){return e instanceof Error&&(e.name==="AbortError"||e.name==="TimeoutError")}function Re({apiKey:e,environmentVariableName:n,apiKeyParameterName:t="apiKey",description:r}){if(typeof e=="string")return e;if(e!=null)throw new R({message:`${r} API key must be a string.`});if(typeof process>"u")throw new R({message:`${r} API key is missing. Pass it using the '${t}' parameter. Environment variables is not supported in this environment.`});if(e=at[n],e==null)throw new R({message:`${r} API key is missing. Pass it using the '${t}' parameter or the ${n} environment variable.`});if(typeof e!="string")throw new R({message:`${r} API key must be a string. The value of the ${n} environment variable is not a string.`});return e}var Z=Symbol.for("vercel.ai.validator");function it(e){return{[Z]:!0,validate:e}}function lt(e){return typeof e=="object"&&e!==null&&Z in e&&e[Z]===!0&&"validate"in e}function ut(e){return lt(e)?e:ct(e)}function ct(e){return it(n=>{const t=e.safeParse(n);return t.success?{success:!0,value:t.data}:{success:!1,error:t.error}})}function pt({value:e,schema:n}){const t=Je({value:e,schema:n});if(!t.success)throw H.wrap({value:e,cause:t.error});return t.value}function Je({value:e,schema:n}){const t=ut(n);try{if(t.validate==null)return{success:!0,value:e};const r=t.validate(e);return r.success?r:{success:!1,error:H.wrap({value:e,cause:r.error})}}catch(r){return{success:!1,error:H.wrap({value:e,cause:r})}}}function dt({text:e,schema:n}){try{const t=ee.parse(e);return n==null?t:pt({value:t,schema:n})}catch(t){throw J.isJSONParseError(t)||H.isTypeValidationError(t)?t:new J({text:e,cause:t})}}function He({text:e,schema:n}){try{const t=ee.parse(e);return n==null?{success:!0,value:t}:Je({value:t,schema:n})}catch(t){return{success:!1,error:J.isJSONParseError(t)?t:new J({text:e,cause:t})}}}function ce(e){try{return ee.parse(e),!0}catch{return!1}}function mt(e){return Object.fromEntries(Object.entries(e).filter(([n,t])=>t!=null))}var ht=()=>globalThis.fetch,A=async({url:e,headers:n,body:t,failedResponseHandler:r,successfulResponseHandler:i,abortSignal:a,fetch:l})=>ft({url:e,headers:{"Content-Type":"application/json",...n},body:{content:JSON.stringify(t),values:t},failedResponseHandler:r,successfulResponseHandler:i,abortSignal:a,fetch:l}),ft=async({url:e,headers:n={},body:t,successfulResponseHandler:r,failedResponseHandler:i,abortSignal:a,fetch:l=ht()})=>{try{const o=await l(e,{method:"POST",headers:mt(n),body:t.content,signal:a}),u=q(o);if(!o.ok){let c;try{c=await i({response:o,url:e,requestBodyValues:t.values})}catch(d){throw U(d)||E.isAPICallError(d)?d:new E({message:"Failed to process error response",cause:d,statusCode:o.status,url:e,responseHeaders:u,requestBodyValues:t.values})}throw c.value}try{return await r({response:o,url:e,requestBodyValues:t.values})}catch(c){throw c instanceof Error&&(U(c)||E.isAPICallError(c))?c:new E({message:"Failed to process successful response",cause:c,statusCode:o.status,url:e,responseHeaders:u,requestBodyValues:t.values})}}catch(o){if(U(o))throw o;if(o instanceof TypeError&&o.message==="fetch failed"){const u=o.cause;if(u!=null)throw new E({message:`Cannot connect to API: ${u.message}`,cause:u,url:e,requestBodyValues:t.values,isRetryable:!0})}throw o}},gt=({errorSchema:e,errorToMessage:n,isRetryable:t})=>async({response:r,url:i,requestBodyValues:a})=>{const l=await r.text(),o=q(r);if(l.trim()==="")return{responseHeaders:o,value:new E({message:r.statusText,url:i,requestBodyValues:a,statusCode:r.status,responseHeaders:o,responseBody:l,isRetryable:t==null?void 0:t(r)})};try{const u=dt({text:l,schema:e});return{responseHeaders:o,value:new E({message:n(u),url:i,requestBodyValues:a,statusCode:r.status,responseHeaders:o,responseBody:l,data:u,isRetryable:t==null?void 0:t(r,u)})}}catch{return{responseHeaders:o,value:new E({message:r.statusText,url:i,requestBodyValues:a,statusCode:r.status,responseHeaders:o,responseBody:l,isRetryable:t==null?void 0:t(r)})}}},Me=e=>async({response:n})=>{const t=q(n);if(n.body==null)throw new Ye({});return{responseHeaders:t,value:n.body.pipeThrough(new TextDecoderStream).pipeThrough(new Be).pipeThrough(new TransformStream({transform({data:r},i){r!=="[DONE]"&&i.enqueue(He({text:r,schema:e}))}}))}},te=e=>async({response:n,url:t,requestBodyValues:r})=>{const i=await n.text(),a=He({text:i,schema:e}),l=q(n);if(!a.success)throw new E({message:"Invalid JSON response",cause:a.error,statusCode:n.status,responseHeaders:l,responseBody:i,url:t,requestBodyValues:r});return{responseHeaders:l,value:a.value}},{btoa:bt}=globalThis;function yt(e){let n="";for(let t=0;t<e.length;t++)n+=String.fromCodePoint(e[t]);return bt(n)}function qe(e){return e==null?void 0:e.replace(/\/$/,"")}function vt({prompt:e,useLegacyFunctionCalling:n=!1}){const t=[];for(const{role:r,content:i}of e)switch(r){case"system":{t.push({role:"system",content:i});break}case"user":{if(i.length===1&&i[0].type==="text"){t.push({role:"user",content:i[0].text});break}t.push({role:"user",content:i.map(a=>{var l;switch(a.type){case"text":return{type:"text",text:a.text};case"image":return{type:"image_url",image_url:{url:a.image instanceof URL?a.image.toString():`data:${(l=a.mimeType)!=null?l:"image/jpeg"};base64,${yt(a.image)}`}}}})});break}case"assistant":{let a="";const l=[];for(const o of i)switch(o.type){case"text":{a+=o.text;break}case"tool-call":{l.push({id:o.toolCallId,type:"function",function:{name:o.toolName,arguments:JSON.stringify(o.args)}});break}default:{const u=o;throw new Error(`Unsupported part: ${u}`)}}if(n){if(l.length>1)throw new y({functionality:"useLegacyFunctionCalling with multiple tool calls in one message"});t.push({role:"assistant",content:a,function_call:l.length>0?l[0].function:void 0})}else t.push({role:"assistant",content:a,tool_calls:l.length>0?l:void 0});break}case"tool":{for(const a of i)n?t.push({role:"function",name:a.toolName,content:JSON.stringify(a.result)}):t.push({role:"tool",tool_call_id:a.toolCallId,content:JSON.stringify(a.result)});break}default:{const a=r;throw new Error(`Unsupported role: ${a}`)}}return t}function pe(e){var n,t;return(t=(n=e==null?void 0:e.content)==null?void 0:n.map(({token:r,logprob:i,top_logprobs:a})=>({token:r,logprob:i,topLogprobs:a?a.map(({token:l,logprob:o})=>({token:l,logprob:o})):[]})))!=null?t:void 0}function M(e){switch(e){case"stop":return"stop";case"length":return"length";case"content_filter":return"content-filter";case"function_call":case"tool_calls":return"tool-calls";default:return"unknown"}}var ne=s.object({error:s.object({message:s.string(),type:s.string().nullish(),param:s.any().nullish(),code:s.union([s.string(),s.number()]).nullish()})}),O=gt({errorSchema:ne,errorToMessage:e=>e.error.message}),Le=class{constructor(e,n,t){this.specificationVersion="v1",this.modelId=e,this.settings=n,this.config=t}get supportsStructuredOutputs(){return this.settings.structuredOutputs===!0}get defaultObjectGenerationMode(){return this.supportsStructuredOutputs?"json":"tool"}get provider(){return this.config.provider}getArgs({mode:e,prompt:n,maxTokens:t,temperature:r,topP:i,topK:a,frequencyPenalty:l,presencePenalty:o,stopSequences:u,responseFormat:c,seed:d}){var f;const m=e.type,p=[];a!=null&&p.push({type:"unsupported-setting",setting:"topK"}),c!=null&&c.type==="json"&&c.schema!=null&&p.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format schema is not supported"});const h=this.settings.useLegacyFunctionCalling;if(h&&this.settings.parallelToolCalls===!0)throw new y({functionality:"useLegacyFunctionCalling with parallelToolCalls"});if(h&&this.settings.structuredOutputs===!0)throw new y({functionality:"structuredOutputs with useLegacyFunctionCalling"});const v={model:this.modelId,logit_bias:this.settings.logitBias,logprobs:this.settings.logprobs===!0||typeof this.settings.logprobs=="number"?!0:void 0,top_logprobs:typeof this.settings.logprobs=="number"?this.settings.logprobs:typeof this.settings.logprobs=="boolean"&&this.settings.logprobs?0:void 0,user:this.settings.user,parallel_tool_calls:this.settings.parallelToolCalls,max_tokens:t,temperature:r,top_p:i,frequency_penalty:l,presence_penalty:o,stop:u,seed:d,response_format:(c==null?void 0:c.type)==="json"?{type:"json_object"}:void 0,messages:vt({prompt:n,useLegacyFunctionCalling:h})};switch(m){case"regular":return{args:{...v,...Et({mode:e,useLegacyFunctionCalling:h,structuredOutputs:this.settings.structuredOutputs})},warnings:p};case"object-json":return{args:{...v,response_format:this.settings.structuredOutputs===!0?{type:"json_schema",json_schema:{schema:e.schema,strict:!0,name:(f=e.name)!=null?f:"response",description:e.description}}:{type:"json_object"}},warnings:p};case"object-tool":return{args:h?{...v,function_call:{name:e.tool.name},functions:[{name:e.tool.name,description:e.tool.description,parameters:e.tool.parameters}]}:{...v,tool_choice:{type:"function",function:{name:e.tool.name}},tools:[{type:"function",function:{name:e.tool.name,description:e.tool.description,parameters:e.tool.parameters,strict:this.settings.structuredOutputs===!0?!0:void 0}}]},warnings:p};default:{const I=m;throw new Error(`Unsupported type: ${I}`)}}}async doGenerate(e){var n,t;const{args:r,warnings:i}=this.getArgs(e),{responseHeaders:a,value:l}=await A({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:T(this.config.headers(),e.headers),body:r,failedResponseHandler:O,successfulResponseHandler:te(wt),abortSignal:e.abortSignal,fetch:this.config.fetch}),{messages:o,...u}=r,c=l.choices[0];return{text:(n=c.message.content)!=null?n:void 0,toolCalls:this.settings.useLegacyFunctionCalling&&c.message.function_call?[{toolCallType:"function",toolCallId:j(),toolName:c.message.function_call.name,args:c.message.function_call.arguments}]:(t=c.message.tool_calls)==null?void 0:t.map(d=>{var f;return{toolCallType:"function",toolCallId:(f=d.id)!=null?f:j(),toolName:d.function.name,args:d.function.arguments}}),finishReason:M(c.finish_reason),usage:{promptTokens:l.usage.prompt_tokens,completionTokens:l.usage.completion_tokens},rawCall:{rawPrompt:o,rawSettings:u},rawResponse:{headers:a},warnings:i,logprobs:pe(c.logprobs)}}async doStream(e){const{args:n,warnings:t}=this.getArgs(e),{responseHeaders:r,value:i}=await A({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:T(this.config.headers(),e.headers),body:{...n,stream:!0,stream_options:this.config.compatibility==="strict"?{include_usage:!0}:void 0},failedResponseHandler:O,successfulResponseHandler:Me(_t),abortSignal:e.abortSignal,fetch:this.config.fetch}),{messages:a,...l}=n,o=[];let u="unknown",c={promptTokens:Number.NaN,completionTokens:Number.NaN},d;const{useLegacyFunctionCalling:f}=this.settings;return{stream:i.pipeThrough(new TransformStream({transform(m,p){var h,v,I,x,P,$,se,re,oe,ae,ie,le;if(!m.success){u="error",p.enqueue({type:"error",error:m.error});return}const C=m.value;if("error"in C){u="error",p.enqueue({type:"error",error:C.error});return}C.usage!=null&&(c={promptTokens:C.usage.prompt_tokens,completionTokens:C.usage.completion_tokens});const k=C.choices[0];if((k==null?void 0:k.finish_reason)!=null&&(u=M(k.finish_reason)),(k==null?void 0:k.delta)==null)return;const S=k.delta;S.content!=null&&p.enqueue({type:"text-delta",textDelta:S.content});const L=pe(k==null?void 0:k.logprobs);L!=null&&L.length&&(d===void 0&&(d=[]),d.push(...L));const ue=f&&S.function_call!=null?[{type:"function",id:j(),function:S.function_call,index:0}]:S.tool_calls;if(ue!=null)for(const b of ue){const N=b.index;if(o[N]==null){if(b.type!=="function")throw new V({data:b,message:"Expected 'function' type."});if(b.id==null)throw new V({data:b,message:"Expected 'id' to be a string."});if(((h=b.function)==null?void 0:h.name)==null)throw new V({data:b,message:"Expected 'function.name' to be a string."});o[N]={id:b.id,type:"function",function:{name:b.function.name,arguments:(v=b.function.arguments)!=null?v:""}};const _=o[N];((I=_.function)==null?void 0:I.name)!=null&&((x=_.function)==null?void 0:x.arguments)!=null&&ce(_.function.arguments)&&(p.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:_.id,toolName:_.function.name,argsTextDelta:_.function.arguments}),p.enqueue({type:"tool-call",toolCallType:"function",toolCallId:(P=_.id)!=null?P:j(),toolName:_.function.name,args:_.function.arguments}));continue}const w=o[N];(($=b.function)==null?void 0:$.arguments)!=null&&(w.function.arguments+=(re=(se=b.function)==null?void 0:se.arguments)!=null?re:""),p.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:w.id,toolName:w.function.name,argsTextDelta:(oe=b.function.arguments)!=null?oe:""}),((ae=w.function)==null?void 0:ae.name)!=null&&((ie=w.function)==null?void 0:ie.arguments)!=null&&ce(w.function.arguments)&&p.enqueue({type:"tool-call",toolCallType:"function",toolCallId:(le=w.id)!=null?le:j(),toolName:w.function.name,args:w.function.arguments})}},flush(m){m.enqueue({type:"finish",finishReason:u,logprobs:d,usage:c})}})),rawCall:{rawPrompt:a,rawSettings:l},rawResponse:{headers:r},warnings:t}}},wt=s.object({choices:s.array(s.object({message:s.object({role:s.literal("assistant").nullish(),content:s.string().nullish(),function_call:s.object({arguments:s.string(),name:s.string()}).nullish(),tool_calls:s.array(s.object({id:s.string().nullish(),type:s.literal("function"),function:s.object({name:s.string(),arguments:s.string()})})).nullish()}),index:s.number(),logprobs:s.object({content:s.array(s.object({token:s.string(),logprob:s.number(),top_logprobs:s.array(s.object({token:s.string(),logprob:s.number()}))})).nullable()}).nullish(),finish_reason:s.string().nullish()})),usage:s.object({prompt_tokens:s.number(),completion_tokens:s.number()})}),_t=s.union([s.object({choices:s.array(s.object({delta:s.object({role:s.enum(["assistant"]).nullish(),content:s.string().nullish(),function_call:s.object({name:s.string().optional(),arguments:s.string().optional()}).nullish(),tool_calls:s.array(s.object({index:s.number(),id:s.string().nullish(),type:s.literal("function").optional(),function:s.object({name:s.string().nullish(),arguments:s.string().nullish()})})).nullish()}).nullish(),logprobs:s.object({content:s.array(s.object({token:s.string(),logprob:s.number(),top_logprobs:s.array(s.object({token:s.string(),logprob:s.number()}))})).nullable()}).nullish(),finish_reason:s.string().nullable().optional(),index:s.number()})),usage:s.object({prompt_tokens:s.number(),completion_tokens:s.number()}).nullish()}),ne]);function Et({mode:e,useLegacyFunctionCalling:n=!1,structuredOutputs:t=!1}){var r;const i=(r=e.tools)!=null&&r.length?e.tools:void 0;if(i==null)return{tools:void 0,tool_choice:void 0};const a=e.toolChoice;if(n){const u=i.map(d=>({name:d.name,description:d.description,parameters:d.parameters}));if(a==null)return{functions:u,function_call:void 0};switch(a.type){case"auto":case"none":case void 0:return{functions:u,function_call:void 0};case"required":throw new y({functionality:"useLegacyFunctionCalling and toolChoice: required"});default:return{functions:u,function_call:{name:a.toolName}}}}const l=i.map(u=>({type:"function",function:{name:u.name,description:u.description,parameters:u.parameters,strict:t===!0?!0:void 0}}));if(a==null)return{tools:l,tool_choice:void 0};const o=a.type;switch(o){case"auto":case"none":case"required":return{tools:l,tool_choice:o};case"tool":return{tools:l,tool_choice:{type:"function",function:{name:a.toolName}}};default:{const u=o;throw new Error(`Unsupported tool choice type: ${u}`)}}}function kt({prompt:e,inputFormat:n,user:t="user",assistant:r="assistant"}){if(n==="prompt"&&e.length===1&&e[0].role==="user"&&e[0].content.length===1&&e[0].content[0].type==="text")return{prompt:e[0].content[0].text};let i="";e[0].role==="system"&&(i+=`${e[0].content}

`,e=e.slice(1));for(const{role:a,content:l}of e)switch(a){case"system":throw new We({message:"Unexpected system message in prompt: ${content}",prompt:e});case"user":{const o=l.map(u=>{switch(u.type){case"text":return u.text;case"image":throw new y({functionality:"images"})}}).join("");i+=`${t}:
${o}

`;break}case"assistant":{const o=l.map(u=>{switch(u.type){case"text":return u.text;case"tool-call":throw new y({functionality:"tool-call messages"})}}).join("");i+=`${r}:
${o}

`;break}case"tool":throw new y({functionality:"tool messages"});default:{const o=a;throw new Error(`Unsupported role: ${o}`)}}return i+=`${r}:
`,{prompt:i,stopSequences:[`
${t}:`]}}function de(e){return e==null?void 0:e.tokens.map((n,t)=>({token:n,logprob:e.token_logprobs[t],topLogprobs:e.top_logprobs?Object.entries(e.top_logprobs[t]).map(([r,i])=>({token:r,logprob:i})):[]}))}var Ve=class{constructor(e,n,t){this.specificationVersion="v1",this.defaultObjectGenerationMode=void 0,this.modelId=e,this.settings=n,this.config=t}get provider(){return this.config.provider}getArgs({mode:e,inputFormat:n,prompt:t,maxTokens:r,temperature:i,topP:a,topK:l,frequencyPenalty:o,presencePenalty:u,stopSequences:c,responseFormat:d,seed:f}){var m;const p=e.type,h=[];l!=null&&h.push({type:"unsupported-setting",setting:"topK"}),d!=null&&d.type!=="text"&&h.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format is not supported."});const{prompt:v,stopSequences:I}=kt({prompt:t,inputFormat:n}),x=[...I??[],...c??[]],P={model:this.modelId,echo:this.settings.echo,logit_bias:this.settings.logitBias,logprobs:typeof this.settings.logprobs=="number"?this.settings.logprobs:typeof this.settings.logprobs=="boolean"&&this.settings.logprobs?0:void 0,suffix:this.settings.suffix,user:this.settings.user,max_tokens:r,temperature:i,top_p:a,frequency_penalty:o,presence_penalty:u,seed:f,prompt:v,stop:x.length>0?x:void 0};switch(p){case"regular":{if((m=e.tools)!=null&&m.length)throw new y({functionality:"tools"});if(e.toolChoice)throw new y({functionality:"toolChoice"});return{args:P,warnings:h}}case"object-json":throw new y({functionality:"object-json mode"});case"object-tool":throw new y({functionality:"object-tool mode"});default:{const $=p;throw new Error(`Unsupported type: ${$}`)}}}async doGenerate(e){const{args:n,warnings:t}=this.getArgs(e),{responseHeaders:r,value:i}=await A({url:this.config.url({path:"/completions",modelId:this.modelId}),headers:T(this.config.headers(),e.headers),body:n,failedResponseHandler:O,successfulResponseHandler:te(It),abortSignal:e.abortSignal,fetch:this.config.fetch}),{prompt:a,...l}=n,o=i.choices[0];return{text:o.text,usage:{promptTokens:i.usage.prompt_tokens,completionTokens:i.usage.completion_tokens},finishReason:M(o.finish_reason),logprobs:de(o.logprobs),rawCall:{rawPrompt:a,rawSettings:l},rawResponse:{headers:r},warnings:t}}async doStream(e){const{args:n,warnings:t}=this.getArgs(e),{responseHeaders:r,value:i}=await A({url:this.config.url({path:"/completions",modelId:this.modelId}),headers:T(this.config.headers(),e.headers),body:{...n,stream:!0,stream_options:this.config.compatibility==="strict"?{include_usage:!0}:void 0},failedResponseHandler:O,successfulResponseHandler:Me(Ct),abortSignal:e.abortSignal,fetch:this.config.fetch}),{prompt:a,...l}=n;let o="unknown",u={promptTokens:Number.NaN,completionTokens:Number.NaN},c;return{stream:i.pipeThrough(new TransformStream({transform(d,f){if(!d.success){o="error",f.enqueue({type:"error",error:d.error});return}const m=d.value;if("error"in m){o="error",f.enqueue({type:"error",error:m.error});return}m.usage!=null&&(u={promptTokens:m.usage.prompt_tokens,completionTokens:m.usage.completion_tokens});const p=m.choices[0];(p==null?void 0:p.finish_reason)!=null&&(o=M(p.finish_reason)),(p==null?void 0:p.text)!=null&&f.enqueue({type:"text-delta",textDelta:p.text});const h=de(p==null?void 0:p.logprobs);h!=null&&h.length&&(c===void 0&&(c=[]),c.push(...h))},flush(d){d.enqueue({type:"finish",finishReason:o,logprobs:c,usage:u})}})),rawCall:{rawPrompt:a,rawSettings:l},rawResponse:{headers:r},warnings:t}}},It=s.object({choices:s.array(s.object({text:s.string(),finish_reason:s.string(),logprobs:s.object({tokens:s.array(s.string()),token_logprobs:s.array(s.number()),top_logprobs:s.array(s.record(s.string(),s.number())).nullable()}).nullable().optional()})),usage:s.object({prompt_tokens:s.number(),completion_tokens:s.number()})}),Ct=s.union([s.object({choices:s.array(s.object({text:s.string(),finish_reason:s.string().nullish(),index:s.number(),logprobs:s.object({tokens:s.array(s.string()),token_logprobs:s.array(s.number()),top_logprobs:s.array(s.record(s.string(),s.number())).nullable()}).nullable().optional()})),usage:s.object({prompt_tokens:s.number(),completion_tokens:s.number()}).optional().nullable()}),ne]),$t=class{constructor(e={}){var n,t;this.baseURL=(t=qe((n=e.baseURL)!=null?n:e.baseUrl))!=null?t:"https://api.openai.com/v1",this.apiKey=e.apiKey,this.organization=e.organization,this.project=e.project,this.headers=e.headers}get baseConfig(){return{organization:this.organization,baseURL:this.baseURL,headers:()=>({Authorization:`Bearer ${Re({apiKey:this.apiKey,environmentVariableName:"OPENAI_API_KEY",description:"OpenAI"})}`,"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this.headers})}}chat(e,n={}){return new Le(e,n,{provider:"openai.chat",...this.baseConfig,compatibility:"strict",url:({path:t})=>`${this.baseURL}${t}`})}completion(e,n={}){return new Ve(e,n,{provider:"openai.completion",...this.baseConfig,compatibility:"strict",url:({path:t})=>`${this.baseURL}${t}`})}},xt=class{constructor(e,n,t){this.specificationVersion="v1",this.modelId=e,this.settings=n,this.config=t}get provider(){return this.config.provider}get maxEmbeddingsPerCall(){var e;return(e=this.settings.maxEmbeddingsPerCall)!=null?e:2048}get supportsParallelCalls(){var e;return(e=this.settings.supportsParallelCalls)!=null?e:!0}async doEmbed({values:e,headers:n,abortSignal:t}){if(e.length>this.maxEmbeddingsPerCall)throw new nt({provider:this.provider,modelId:this.modelId,maxEmbeddingsPerCall:this.maxEmbeddingsPerCall,values:e});const{responseHeaders:r,value:i}=await A({url:this.config.url({path:"/embeddings",modelId:this.modelId}),headers:T(this.config.headers(),n),body:{model:this.modelId,input:e,encoding_format:"float",dimensions:this.settings.dimensions,user:this.settings.user},failedResponseHandler:O,successfulResponseHandler:te(St),abortSignal:t,fetch:this.config.fetch});return{embeddings:i.data.map(a=>a.embedding),usage:i.usage?{tokens:i.usage.prompt_tokens}:void 0,rawResponse:{headers:r}}}},St=s.object({data:s.array(s.object({embedding:s.array(s.number())})),usage:s.object({prompt_tokens:s.number()}).nullish()});function jt(e={}){var n,t,r;const i=(t=qe((n=e.baseURL)!=null?n:e.baseUrl))!=null?t:"https://api.openai.com/v1",a=(r=e.compatibility)!=null?r:"compatible",l=()=>({Authorization:`Bearer ${Re({apiKey:e.apiKey,environmentVariableName:"OPENAI_API_KEY",description:"OpenAI"})}`,"OpenAI-Organization":e.organization,"OpenAI-Project":e.project,...e.headers}),o=(m,p={})=>new Le(m,p,{provider:"openai.chat",url:({path:h})=>`${i}${h}`,headers:l,compatibility:a,fetch:e.fetch}),u=(m,p={})=>new Ve(m,p,{provider:"openai.completion",url:({path:h})=>`${i}${h}`,headers:l,compatibility:a,fetch:e.fetch}),c=(m,p={})=>new xt(m,p,{provider:"openai.embedding",url:({path:h})=>`${i}${h}`,headers:l,fetch:e.fetch}),d=(m,p)=>{if(new.target)throw new Error("The OpenAI model function cannot be called with the new keyword.");return m==="gpt-3.5-turbo-instruct"?u(m,p):o(m,p)},f=function(m,p){return d(m,p)};return f.languageModel=d,f.chat=o,f.completion=u,f.embedding=c,f.textEmbedding=c,f}var Nt=jt({compatibility:"strict"});export{$t as OpenAI,jt as createOpenAI,Nt as openai};
